---
title: "First attempts with simple features"
author: "Leo Lee"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    toc: TRUE
    keep_md: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "#>", message = FALSE, warning = FALSE)
library(sf)
library(dplyr)
# devtools::install_github("tidyverse/ggplot2")
library(stringr) 
library(viridis)    # 地图调色盘
library(hrbrthemes) # optional - but awesome and highly recommended
library(extrafont) # optional, might be required if you are a windows user and want to use hrbrthemes
```


The latest edition of the [Scottish Index of Multiple Deprivation (SIMD)](http://www.gov.scot/Topics/Statistics/SIMD) was released last year, and has been getting a bit more promotion recently as part of Scotland’s open data - for example, an [R package](http://www.gov.scot/Topics/Statistics/SIMD/analysis/openSIMD) has been made available to calculate the SIMD rankings.

The purpose of the SIMD is that it “identifies small area concentrations of multiple deprivation across all of Scotland in a consistent way. It allows effective targeting of policies and funding where the aim is to wholly or partly tackle or take account of area concentrations of multiple deprivation.

SIMD ranks small areas (called data zones) from most deprived (ranked 1) to least deprived (ranked 6,976). People using SIMD will often focus on the data zones below a certain rank, for example, the 5%, 10%, 15% or 20% most deprived data zones in Scotland.

SIMD provides a wealth of information to help improve the understanding about the outcomes and circumstances of people living in the most deprived areas in Scotland” ( from the main website linked above).

To put this into more practical terms, each Local Authority area in Scotland is divided into DataZones, with a roughly equal population in each. Each zone is ranked (low to high, higher is less deprived) on a variety of metrics covering health, education, access to services, housing etc. Various spreadsheets, database files and shape files are now available for analysis.

There are already some great examples of mapping online, including a fantastic interactive map, but I wanted to try mapping it myself using the “sf” package.

If you want to follow along, a couple of things you need to bear in mind:


* You’ll need to download shapefiles from this link on the SIMD page
* You’ll need to install the dev version of `ggplot2` in order to benefit from `geom_sf()`. 
This will involve devtools, and on Windows, RTools in order to download and install the package successfully.
First install the devtools package from your usual package repository, and then use “devtools::install_github(“tidyverse/ggplot2”)” to install the development version.

loaded packages
```
ggplot2, sf, stringr, dplyr, hrbrthemes, viridis, extrafont
```
You’ll see I’m using hrbrthemes - which is very, very nice indeed. You are free to use other themes of course, but if you haven’t at least tried hrbrthemes then do yourself a favour. This was the first time I’d used it and it’s definitely my default for the foreseeable future.

I’m also using extrafont - for Windows users, you may find errors relating to missing fonts when trying hrbrthemes and other custom themes without this packaged being installed. It makes it easier to add additional fonts to your system. Install the package, this will install “extrafontdb” - and follow the help to register the fonts on your system - this takes a while initially but worth doing (it’s just one command - font_import() -so not too onerous).

Right - to the actual mapping.

## 导入`shp`数据
First, read in the shape file:

```{r}
scot <- st_read("C:\\Users\\hjlgz\\Documents\\R_maps\\SG_SIMD_2016.shp") 
```

> **注意：用st_read()读取本地shp文件时，文件目录名称不能含有中文！！！**

```{r}
str(scot)
head(scot)
```


This results in a dataframe and sf object incorporating 6976 observations and 50 variables.

Then, for simplicity, I’m going to change all the variables to lowercase, and create a smaller dataframe for all the observations relating to the Highland region ( by filtering on ‘laname’):

```{r}
colnames(scot) <- colnames(scot) %>% 
  str_to_lower()
colnames(scot)

highland <- filter(scot, laname == "Highland")
head(highland)
```


The code below will give a map of the Highland region coloured by quintile ( that is, a score of 1-5, with 1 indicating the most deprived areas and 5 the least):

```{r}
ggplot(highland) +
  geom_sf(aes(fill = quintile)) +
  scale_fill_viridis("quintile",option = "C",
                     guide = guide_legend(title = "Quintile")) +
  ggtitle("SIMD 2016 - Highland Council Area by Quintile",
          subtitle = "1 = most deprived, 5 = least deprived") +
  theme_ipsum(base_size = 10) +
  theme(plot.title = element_text(hjust = 0))
```

here are quite a few interesting variables within the dataset. The SIMD scores are available by quintile, decile and vigintile, plus overall all rankings by domains such as health and education, and the main SIMD ranking where 1 is the most deprived and 6976 is the least deprived datazone (in Renfrewshire, and East Renfrewshire respectively, if you’re interested).

Here are some of the other plots I produced - the code being remarkably similar to the above example in all cases:

Scotland by quintile:
```{r}
ggplot(scot) +
  geom_sf(aes(fill = quintile)) +
  scale_fill_viridis("quintile",option = "C") +
  ggtitle("SIMD 2016 - Scotland by Quintile",
          subtitle = "1 = most deprived, 5 = least deprived") +
  theme_ipsum(base_size = 10) 
```

The problem with this plot is that quite a large chunk of the central belt does not appear to have rendered correctly - too much absence of colour. This is because of the density of the datazones and the thickness of the polygon lines.

So let’s have a look at Edinburgh and Glasgow, the 2 main cities, using a different `viridis` palette:

I mentioned that the area around Renfrew had the lowest and highest ranked datazones, so let’s take a look at them:
```{r}
renfrew <- filter(scot,laname %in% c("East Renfrewshire","Renfrewshire"))
 ggplot(renfrew) +
  geom_sf(aes(fill = quintile)) +
  scale_fill_viridis("quintile",option = "C",
                     guide = guide_legend(title = "Quintile")) +
  ggtitle("SIMD 2016 - Renfrewshire & East Renfrewshire by Quintile",
          subtitle = "1 = most deprived, 5 = least deprived") +
  theme_ipsum(base_size = 10) +
  facet_wrap(~laname)
```


Give me fuel, give me fire, reduced deprivation’s my desire
A focus on the Highlands now. Amongst the many variables are some relating to the availability of central heating within homes, and average drive times to access local services, such as retail, GP’s, and petrol stations:
```{r}
#### overall ranking ###
  ggplot(highland)+
    geom_sf(aes(fill = rank ))+
    scale_fill_viridis_c("rank",option = "C",
                         guide = guide_legend(title = "SIMD 2016 Rank")) +
    ggtitle(label = " Overall Datazone Ranking",
            subtitle = "Highland Council Area - SIMD 2016") +
    labs(caption = " data from http://www.gov.scot/Topics/Statistics/SIMD") +
    theme_ipsum(base_size = 10)
# ggsave("highland-rank.png",width = 8.41, height = 5.94)
```

Give me fuel, give me fire, reduced deprivation’s my desire
A focus on the Highlands now. Amongst the many variables are some relating to the availability of central heating within homes, and average drive times to access local services, such as retail, GP’s, and petrol stations:
```{r}
glasgow <- filter(top_two, laname == "Glasgow City")
edinburgh <- filter(top_two, laname == "City of Edinburgh")
 
 
 ggplot(glasgow) +
   geom_sf(aes(fill = hlthdprspc *100)) +
   scale_fill_viridis("hlthdprspc",option = "A", direction =-1,
                      guide = guide_legend(title = "% population"))+
   ggtitle(label = "Proportion prescribed drugs for depression : Glasgow",
           subtitle = "Scotland  - SIMD 2016") +
   #labs(caption = " data from http://www.gov.scot/Topics/Statistics/SIMD") +
   labs(caption = "Proportion of population being prescribed drugs for anxiety, depression or psychosis \n Source http://www.gov.scot/Topics/Statistics/SIMD")+
   theme_ipsum(base_size = 10) 
# ggsave("glasgow_depression.png",width = 8.41, height = 5.94)
```



```{r}
ggplot(edinburgh) +
   geom_sf(aes(fill = hlthdprspc *100)) +
   scale_fill_viridis("hlthdprspc",option = "A", direction =-1,
                      guide = guide_legend(title = "% population"))+
   ggtitle(label = "Proportion prescribed drugs for depression : Edinburgh",
           subtitle = "Scotland  - SIMD 2016") +
   #labs(caption = " data from http://www.gov.scot/Topics/Statistics/SIMD") +
   labs(caption = "Proportion of population being prescribed drugs for anxiety, depression or psychosis \n Source http://www.gov.scot/Topics/Statistics/SIMD")+
   theme_ipsum(base_size = 10) 
# ggsave("edinburgh_depression.png",width = 8.41, height = 5.94)
 
 
aberdeen <- scot %>% filter(laname %in% c("Aberdeen City","Aberdeenshire"))
ggplot(aberdeen) +
  geom_sf(aes(fill = hlthdprspc *100)) +
  scale_fill_viridis("hlthdprspc",option = "A", direction =-1,
                     guide = guide_legend(title = "% population"))+
  ggtitle(label = "Proportion prescribed drugs for depression : Aberdeen",
          subtitle = "Scotland  - SIMD 2016") +
  #labs(caption = " data from http://www.gov.scot/Topics/Statistics/SIMD") +
  labs(caption = "Proportion of population being prescribed drugs for anxiety, depression or psychosis \n Source http://www.gov.scot/Topics/Statistics/SIMD")+
  theme_ipsum(base_size = 10) 
# ggsave("aber-deen-pression.png",width = 8.41, height = 5.94)

#dundee
dundee <- scot %>% filter(laname %in% c("Dundee City"))
ggplot(dundee) +
  geom_sf(aes(fill = hlthdprspc *100)) +
  scale_fill_viridis("hlthdprspc",option = "A", direction =-1,
                     guide = guide_legend(title = "% population"))+
  ggtitle(label = "Proportion prescribed drugs for depression : Dundee",
          subtitle = "Scotland  - SIMD 2016") +
  #labs(caption = " data from http://www.gov.scot/Topics/Statistics/SIMD") +
  labs(caption = "Proportion of population being prescribed drugs for anxiety, depression or psychosis \n Source http://www.gov.scot/Topics/Statistics/SIMD")+
  theme_ipsum(base_size = 10) 
# ggsave("dun-depression.png",width = 8.41, height = 5.94)




# percent no central heating
ggplot(highland) +
  geom_sf(aes(fill = housencrat *100)) +
  scale_fill_viridis("housencrat",option = "C",
  guide = guide_legend(title = "Proportion of population")) +
  ggtitle(label = "Percentage of people in households without central heating",
          subtitle = "Highland Council Area - SIMD 2016") +
  labs(caption = " data from http://www.gov.scot/Topics/Statistics/SIMD") +
  theme_ipsum(base_size = 10)
# ggsave("highland-central-heating.png")


drive <- select(highland,1:9,starts_with("gac"))
#petrol station
ggplot(drive)+
  geom_sf(aes(fill = gaccpetrol)) +
  scale_fill_viridis("gaccpetrol",option = "C",
                     guide = guide_legend(title = "Avg Drive Time (Mins)")) +
  ggtitle(label = "Average Drive Time to Petrol Station (Mins)",
          subtitle = "Highland Council Area - SIMD 2016") +
  labs(caption = " data from http://www.gov.scot/Topics/Statistics/SIMD") +
  theme_ipsum(base_size = 10)
# ggsave("highland-drive-time-petrol.png",width = 8.41, height = 5.94)

# gp 
ggplot(drive)+
  geom_sf(aes(fill = gaccdtgp)) +
  scale_fill_viridis("gaccdtgp",option = "C",
                     guide = guide_legend(title = "Avg Drive Time (Mins)")) +
  ggtitle(label = "Average Drive Time to GP (Mins)",
          subtitle = "Highland Council Area - SIMD 2016") +
  labs(caption = " data from http://www.gov.scot/Topics/Statistics/SIMD") +
  theme_ipsum(base_size = 10)
# ggsave("highland-drive-time-gp.png",width = 8.41, height = 5.94)

##retail park
ggplot(drive)+
  geom_sf(aes(fill = gaccdtret)) +
  scale_fill_viridis("gaccdtret",option = "C",
                     guide = guide_legend(title = "Avg Drive Time (Mins)")) +
  ggtitle(label = "Average Drive Time to Retail Centre (Mins)",
          subtitle = "Highland Council Area - SIMD 2016") +
  labs(caption = " data from http://www.gov.scot/Topics/Statistics/SIMD") +
  theme_ipsum(base_size = 10)
ggsave("highland-drive-time-retail.png",width = 8.41, height = 5.94)

##secondary school
ggplot(drive)+
  geom_sf(aes(fill = gaccdtssch)) +
  scale_fill_viridis("gaccdtssch",option = "C",
                     guide = guide_legend(title = "Avg Drive Time (Mins)")) +
  ggtitle(label = "Average Drive Time to Secondary School (Mins)",
          subtitle = "Highland Council Area - SIMD 2016") +
  labs(caption = " data from http://www.gov.scot/Topics/Statistics/SIMD") +
  theme_ipsum(base_size = 10)
ggsave("highland-drive-time-secschool.png",width = 8.41, height = 5.94)

##spublic transport to gp
ggplot(drive)+
  geom_sf(aes(fill = gaccptgp)) +
  scale_fill_viridis("gaccptgp",option = "C",
                     guide = guide_legend(title = "Pubic Tansport Travel Time(Mins)")) +
  ggtitle(label = "Public transport travel time to a GP surgery (Mins)",
          subtitle = "Highland Council Area - SIMD 2016") +
  labs(caption = " data from http://www.gov.scot/Topics/Statistics/SIMD") +
  theme_ipsum(base_size = 10)
ggsave("highland-pubtrans-time-gp.png",width = 8.41, height = 5.94)
```



















